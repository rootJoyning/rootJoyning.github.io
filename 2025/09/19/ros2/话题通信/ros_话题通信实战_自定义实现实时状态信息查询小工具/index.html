<!doctype html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="keywords" content=""><meta name="description" content=""><meta name="author" content="joyning"><title>话题通信实战_自定义实现实时状态信息查询小工具</title><link rel="alternate" href="/atom.xml" title="在此恭候夷陵老祖的博客" type="application/atom+xml"><link rel="canonical" href="http://example.com/2025/09/19/ros2/%E8%AF%9D%E9%A2%98%E9%80%9A%E4%BF%A1/ros_%E8%AF%9D%E9%A2%98%E9%80%9A%E4%BF%A1%E5%AE%9E%E6%88%98_%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AE%9E%E7%8E%B0%E5%AE%9E%E6%97%B6%E7%8A%B6%E6%80%81%E4%BF%A1%E6%81%AF%E6%9F%A5%E8%AF%A2%E5%B0%8F%E5%B7%A5%E5%85%B7/index.html"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_pb2xepysv85gsyvi.css"><meta name="generator" content="Hexo 7.3.0"></head><body><aside class="aside"><nav class="aside-menu"><ul class="aside-list"><li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang"></i><a href="/index.html" class="aside-menu-link" title="首页">首页</a></li><li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang1"></i><a href="/archives/index.html" class="aside-menu-link" title="所有文章">所有文章</a></li><li class="aside-item"><i class="aside-menu-icon iconfont icon-biaoqian1"></i><a href="/tags/index.html" class="aside-menu-link" title="分类标签">分类标签</a></li><li class="aside-item"><i class="aside-menu-icon iconfont icon-guanyu"></i><a href="/about/index.html" class="aside-menu-link" title="关于">关于</a></li><li class="aside-item"><i class="aside-menu-icon iconfont icon-rss"></i><a href="/atom.xml" class="aside-menu-link" title="RSS">RSS</a></li></ul></nav><article class="aside-show"><div class="aside-show-wrapper"><figure class="aside-avatar"><img src="/img/avatar.png" alt="avatar" class="aside-avatar-img"><figcaption class="aside-avatar-caption">夷陵老祖 <strong class="aside-avatar-STRONG">半码农随想录</strong></figcaption></figure><p class="aside-show-description">为你明灯三千，为你花开满城</p><ul class="aside-show-info"><li class="aside-show-item"><a href="javascript: void(0);" class="aside-show-link" title="微信" target="_blank"><i class="aside-show-icon iconfont icon-iconfontweixin"></i></a><div class="aside-show-outside aside-show-outside_1"><img class="aside-show-IMG aside-show-IMG_1" src="/img/weixin.png" alt="微信"></div></li><li class="aside-show-item"><a href="https://www.zhihu.com/people/chenfengmingwu/activities" class="aside-show-link" title="知乎" target="_blank"><i class="aside-show-icon iconfont icon-zhihu"></i></a></li><li class="aside-show-item"><a href="https://github.com/rootJoyning" class="aside-show-link" title="github" target="_blank"><i class="aside-show-icon iconfont icon-github"></i></a></li><li class="aside-show-item"><a href="javascript: void(0);" class="aside-show-link" title="QQ" target="_blank"><i class="aside-show-icon iconfont icon-qq"></i></a><div class="aside-show-outside"><img class="aside-show-IMG" src="/img/qq.png" alt="QQ"></div></li></ul></div></article></aside><article class="main" id="main"><article class="post min-height"><header class="post-header"><h1 class="post-title">话题通信实战_自定义实现实时状态信息查询小工具</h1><p class="post-meta"><span class="post-time">2025-09-19</span> <a href="/categories/ROS2/" title="ROS2" class="post-categories">ROS2</a> <a href="/tags/ROS2/" title="ROS2" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>ROS2</a> <a href="/tags/Topic-communication/" title="Topic_communication" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>Topic_communication</a></p></header><div class="post-content"><h1 id="话题通信实战-自定义实现实时状态信息查询小工具"><a href="#话题通信实战-自定义实现实时状态信息查询小工具" class="headerlink" title="话题通信实战_自定义实现实时状态信息查询小工具"></a>话题通信实战_自定义实现实时状态信息查询小工具</h1><p><strong>需求：</strong></p><ol><li>通过该工具可以看到系统的实时状态信息，包括记录信息的时间、主机名称、cpu使用率、内存使用率、内存总大小、剩余内存、网络接收数据量和网络发送数据量。</li><li>要有一个简单的界面，可以将系统信息显示出来。</li><li>要能在局域网内其他主机上查看数据。</li></ol><p><strong>分析：</strong></p><ol><li>要能获取系统状态信息–&gt;python库psutils;</li><li>要有一个展示界面–&gt;QT;</li><li>要能共享数据–&gt;ROS2话题。<br>总体架构：&#x2F;sys_status_pub—-&gt;&#x2F;sys_status—&gt;&#x2F;sys_status_display</li></ol><p><strong>步骤：</strong></p><p><strong>1. 自定义通信接口</strong><br>【注】：</p><ul><li><p>builtin_interfaces()：提供时间戳；</p></li><li><p>按照需求编写一个.msg的接口文件。注意：msg文件的命名必须使用驼峰命名法。</p></li><li><p>需要在对应的CMakeList.txt文件中添加rosidl_generate_interfaces()，其为cmake函数，用于将msg消息接口定义文件转化为库或者头文件类。</p><p><strong>具体实现：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rosidl_generate_interfaces($&#123;PROJECT_NAME&#125;</span><br><span class="line">  &quot;msg/SystemStatus.msg&quot;</span><br><span class="line">  DEPENDENCIES builtin_interfaces</span><br></pre></td></tr></table></figure></li></ul><p><strong>代码实现：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">builtin_interfaces/Time stamp #记录时间戳</span><br><span class="line">string host_name #主机名</span><br><span class="line">float32 memory_percent #主存使用率</span><br><span class="line">float32 cpu_percent #CPU使用率</span><br><span class="line">float32 memory_available #主存剩余率</span><br><span class="line">float64 net_send #网络发送率</span><br><span class="line">float64 net_recv #网络接收率</span><br></pre></td></tr></table></figure><p><strong>2. 系统信息获取和发布</strong><br>【注】：使用psutils和platform两个库主要用于获取信息；其中psutil库可以查询cpu利用率、内存情况和网络输出输入情况等。platform库用于查询主机名字等。</p><p><strong>代码实现：</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> rclpy</span><br><span class="line"><span class="keyword">from</span> rclpy.node <span class="keyword">import</span> Node</span><br><span class="line"><span class="keyword">from</span> status_interfaces.msg <span class="keyword">import</span> SystemStatus</span><br><span class="line"><span class="keyword">import</span> psutil</span><br><span class="line"><span class="keyword">import</span> platform</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SystemStatusPub</span>(<span class="title class_ inherited__">Node</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, node_name</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(node_name)</span><br><span class="line">        <span class="variable language_">self</span>.status_publisher_ = <span class="variable language_">self</span>.create_publisher(SystemStatus, <span class="string">&#x27;sys_status&#x27;</span>, <span class="number">10</span>)</span><br><span class="line">        <span class="variable language_">self</span>.time_ = <span class="variable language_">self</span>.create_timer(<span class="number">1.0</span>, <span class="variable language_">self</span>.timer_callback)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">timer_callback</span>(<span class="params">self</span>):</span><br><span class="line">        cup_percent = psutil.cpu_percent()</span><br><span class="line">        memory_info = psutil.virtual_memory() <span class="comment"># 查看当前内存情况</span></span><br><span class="line">        net_io_counters = psutil.net_io_counters() <span class="comment"># 查看网络输入输出情况</span></span><br><span class="line">        </span><br><span class="line">        msg = SystemStatus() <span class="comment"># 自定义的通信接口经过一系列操作变成了类</span></span><br><span class="line">        msg.stamp = <span class="variable language_">self</span>.get_clock().now().to_msg() <span class="comment"># 获取当前时间戳并转化为信息</span></span><br><span class="line">        msg.host_name = platform.node() <span class="comment"># 返回主机名字</span></span><br><span class="line">        msg.cpu_percent = cup_percent</span><br><span class="line">        msg.memory_percent = memory_info.percent</span><br><span class="line">        msg.memory_available = memory_info.available /<span class="number">1024</span>/<span class="number">1024</span><span class="comment"># 有效内存</span></span><br><span class="line">        msg.net_send = net_io_counters.packets_sent /<span class="number">1024</span>/<span class="number">1024</span> <span class="comment"># 将字节转换为兆字节</span></span><br><span class="line">        msg.net_recv = net_io_counters.packets_recv /<span class="number">1024</span>/<span class="number">1024</span></span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.get_logger().info(<span class="string">f&quot;发布相关信息：<span class="subst">&#123;msg&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.status_publisher_.publish(msg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    rclpy.init()</span><br><span class="line">    sys_status_pub = SystemStatusPub(<span class="string">&quot;status_publish&quot;</span>)</span><br><span class="line">    rclpy.spin(sys_status_pub)</span><br><span class="line">    rclpy.shutdown()</span><br></pre></td></tr></table></figure><p><strong>3.订阅数据并用QT显示</strong><br>【注】</p><ul><li>使用new()创建类后需要手动释放内存，只有遇到”delete()”时才会调用析构函数</li><li>使用”类名 创建的类”这种类定义声明的方式使用后不需要手动释放，这种类中的析构函数会自动执行。</li><li>关于类对象的三种创建方法：<br>第一：Test test1; 栈中分配，由os进行内存分配和管理。<br>第二：Test test2 &#x3D; Test(); 栈中分配，由os进行内存分配和管理。<br>第三：Test *test3 &#x3D; new Test(); 堆中分配，由管理者进行内存分配和管理，显式使用delete()释放内存空间。</li><li>“.”:是结构体引用，”-&gt;”:是指针引用。</li></ul><p><strong>代码实现：</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QApplication&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QLabel&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QString&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;rclcpp/rclcpp.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;status_interfaces/msg/system_status.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> SystemStatus = status_interfaces::msg::SystemStatus; <span class="comment">// 将包名进行改名</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SystemStatusDisplay</span> : <span class="keyword">public</span> rclcpp::Node&#123;</span><br><span class="line"><span class="keyword">private</span>:<span class="comment">/*data*/</span></span><br><span class="line">    rclcpp::Subscription&lt;SystemStatus&gt;::SharedPtr subscriber_;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    QLabel *label_ = <span class="keyword">new</span> <span class="built_in">QLabel</span>();</span><br><span class="line">    <span class="built_in">SystemStatusDisplay</span>():<span class="built_in">Node</span>(<span class="string">&quot;sys_status_display&quot;</span>)&#123;</span><br><span class="line">        <span class="comment">// 使用lambda函数作为回调函数,接收的函数为共享指针</span></span><br><span class="line">        subscriber_ = <span class="keyword">this</span>-&gt;<span class="built_in">create_subscription</span>&lt;SystemStatus&gt;(<span class="string">&quot;sys_status&quot;</span>,<span class="number">10</span>,[&amp;](<span class="type">const</span> SystemStatus::SharedPtr msg)-&gt;<span class="type">void</span>&#123;</span><br><span class="line">            label_-&gt;<span class="built_in">setText</span>(<span class="built_in">get_qstr_from_msg</span>(msg));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        label_-&gt;<span class="built_in">setText</span>(<span class="built_in">get_qstr_from_msg</span>(std::<span class="built_in">make_shared</span>&lt;SystemStatus&gt;()));  <span class="comment">// 初始给label传一个空的共享指针，这样有表头没有具体内容。</span></span><br><span class="line">        label_-&gt;<span class="built_in">show</span>();</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function">QString <span class="title">get_qstr_from_msg</span><span class="params">(<span class="type">const</span> SystemStatus::SharedPtr msg)</span></span>&#123;  <span class="comment">// 将获取到的msg内容进行拆分组装</span></span><br><span class="line">        std::stringstream show_str;</span><br><span class="line">        show_str &lt;&lt; <span class="string">&quot;==========状态可视化显示工具============\n&quot;</span> &lt;&lt;</span><br><span class="line">                <span class="string">&quot;数 据 时 间:\t&quot;</span> &lt;&lt; msg-&gt;stamp.sec &lt;&lt; <span class="string">&quot;\ts\n&quot;</span> &lt;&lt;</span><br><span class="line">                <span class="string">&quot;主 机 名:\t&quot;</span> &lt;&lt; msg-&gt;host_name &lt;&lt; <span class="string">&quot;\t\n&quot;</span> &lt;&lt;</span><br><span class="line">                <span class="string">&quot;cpu 利 用 率:\t&quot;</span> &lt;&lt; msg-&gt;cpu_percent &lt;&lt; <span class="string">&quot;\t%\n&quot;</span> &lt;&lt;</span><br><span class="line">                <span class="string">&quot;内 存 利 用 率:\t&quot;</span> &lt;&lt; msg-&gt;memory_percent &lt;&lt; <span class="string">&quot;\t%\n&quot;</span> &lt;&lt;</span><br><span class="line">                <span class="string">&quot;剩 余 有 效 内 存:\t&quot;</span> &lt;&lt; msg-&gt;memory_available &lt;&lt; <span class="string">&quot;\tMB\n&quot;</span> &lt;&lt;</span><br><span class="line">                <span class="string">&quot;网 络 发 送 量:\t&quot;</span> &lt;&lt; msg-&gt;net_send &lt;&lt; <span class="string">&quot;\tMB\n&quot;</span> &lt;&lt;</span><br><span class="line">                <span class="string">&quot;网 络 接 收 量:\t&quot;</span> &lt;&lt; msg-&gt;net_recv &lt;&lt; <span class="string">&quot;\tMB\n&quot;</span> </span><br><span class="line">                &lt;&lt; <span class="string">&quot;=======================================&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> QString::<span class="built_in">fromStdString</span>(show_str.<span class="built_in">str</span>());</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span>&#123;</span><br><span class="line">    rclcpp::<span class="built_in">init</span>(argc, argv);</span><br><span class="line">    <span class="function">QApplication <span class="title">app</span><span class="params">(argc, argv)</span></span>; <span class="comment">//类对象的声明</span></span><br><span class="line">    <span class="keyword">auto</span> node = std::<span class="built_in">make_shared</span>&lt;SystemStatusDisplay&gt;(); <span class="comment">// 创建一个模板为SystemStatusDisplay的共享指针</span></span><br><span class="line">    <span class="function">std::thread <span class="title">spin_thread</span><span class="params">([&amp;]()-&gt;<span class="type">void</span>&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        rclcpp::spin(node); <span class="comment">// 为其单独开一个线程</span></span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;)</span></span>;</span><br><span class="line">    spin_thread.<span class="built_in">detach</span>();</span><br><span class="line">    app.<span class="built_in">exec</span>();</span><br><span class="line">    rclcpp::<span class="built_in">shutdown</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>关于rclcpp::spin()：会阻塞调用它的线程，直到与它关联的节点被销毁。函数执行期间，它执行以下操作：</p><ul><li>处理回调：调用所有已注册的回调，包括订阅者的消息回调、服务的请求回调、定时器回调。</li><li>事件循环：处理所有ROS通信相关的事件，确保节点能够响应外部消息和服务请求。</li><li>阻塞执行：该函数会一直运行，直到调用其的节点被销毁或者显示地调用rclcpp::shutdown()。</li></ul><p><strong>学习收获：</strong></p><ol><li>如何根据需求自定义.msg文件 ；</li><li>如何获取电脑基本参数信息；</li><li>如何进行字符串流输出。</li></ol></div><div class="toc-wrapper"><div class="toc-scroll"><div class="toc-middle"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AF%9D%E9%A2%98%E9%80%9A%E4%BF%A1%E5%AE%9E%E6%88%98-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AE%9E%E7%8E%B0%E5%AE%9E%E6%97%B6%E7%8A%B6%E6%80%81%E4%BF%A1%E6%81%AF%E6%9F%A5%E8%AF%A2%E5%B0%8F%E5%B7%A5%E5%85%B7"><span class="toc-text">话题通信实战_自定义实现实时状态信息查询小工具</span></a></li></ol></div></div></div></article><footer class="footer"><p class="footer-text">&copy; 2016 - 2017 <a href="/about" class="footer-link" title="joyning">joyning</a> 保留部分版权</p></footer></article><script src="/js/to-top.js"></script><script src="/js/search.js"></script></body></html>